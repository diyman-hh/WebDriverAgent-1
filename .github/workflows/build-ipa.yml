name: Build IPA

on:
  workflow_dispatch:
  push:
    branches: [ "master", "main" ]

jobs:
  build:
    name: Build IPA
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build WebDriverAgentRunner
        run: |
          xcodebuild build \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            IPHONEOS_DEPLOYMENT_TARGET=15.0 \
            OTHER_LDFLAGS="-Wl,-no_fixup_chains" \
            ARCHS=arm64

      - name: Package IPA
        run: |
          mkdir Payload
          
          # Find app in build directory (since we are using 'build' action again)
          APP_DIR=$(find build -type d -name "WebDriverAgentRunner-Runner.app" | head -n 1)
          
          if [ -z "$APP_DIR" ]; then
            echo "Error: Could not find .app in build directory"
            find build
            exit 1
          fi
          
          echo "Found compiled app at: $APP_DIR"
          
          # Function to process binaries: check architecture and force arm64
          process_binary() {
              local bin="$1"
              if [ ! -f "$bin" ]; then return; fi
              
              echo "Processing binary: $bin"
              # Check if it is a binary (Mach-O)
              if file "$bin" | grep -q "Mach-O"; then
                  # Always force thin to arm64 to be safe (strips any x86_64 or other archs)
                  echo "  -> Thinning to arm64"
                  lipo -thin arm64 "$bin" -output "$bin.arm64" 2>/dev/null && mv "$bin.arm64" "$bin" || echo "  -> Lipo failed or already thin"
                  chmod +x "$bin"
              fi
          }
          
          # 4. Remove dSYM debug symbols (CRITICAL - causes installation failure)
          # dSYM bundles contain unsigned metadata that iOS rejects
          echo "Removing .dSYM debug symbol bundles..."
          find "$APP_DIR" -name "*.dSYM" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # 5. Inject Dummy embedded.mobileprovision (CRITICAL for AiSi Helper)
          # AiSi Helper flags apps without this file as "Jailbreak Version".
          # We download a generic sample profile to satisfy the structure check.
          # AiSi will replace this with a real one during re-signing.
          echo "Downloading dummy embedded.mobileprovision..."
          curl -L -o "$APP_DIR/embedded.mobileprovision" "https://gist.githubusercontent.com/ben-xD/2eeb11f0eb916977692bb10a6550b94d/raw/embedded.mobileprovision"

          # 5. Simple Ad-Hoc Sign (Avoid fake entitlements)
          # AiSi Helper often flags IPAs with "get-task-allow" as "Jailbreak/Dev" if checks fail.
          # We just generic sign to ensure binary validity.
          
          echo "Ad-hoc signing binaries (No specific entitlements)..."
          
          # Sign Frameworks
          find "$APP_DIR/Frameworks" -type f -name "*.dylib" -o -name "*.framework" | while read fw; do
              codesign -s - -f --preserve-metadata=identifier,flags "$fw"
          done
          
          # Sign PlugIns
          find "$APP_DIR/PlugIns" -type d -name "*.xctest" | while read pl; do
              codesign -s - -f --preserve-metadata=identifier,flags "$pl"
          done
          
          # Sign Main App
          codesign -s - -f --preserve-metadata=identifier,flags "$APP_DIR"
          
          echo "Verifying Info.plist..."
          plutil -p "$APP_DIR/Info.plist"
          
          cp -r "$APP_DIR" Payload/
          zip -r WebDriverAgentRunner.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: WebDriverAgentRunner-IPA
          path: WebDriverAgentRunner.ipa
