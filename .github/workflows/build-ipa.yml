name: Build IPA

on:
  workflow_dispatch:
  push:
    branches: [ "master", "main" ]

jobs:
  build:
    name: Build IPA
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build WebDriverAgentRunner
        run: |
          xcodebuild build \
            -project WebDriverAgent.xcodeproj \
            -scheme WebDriverAgentRunner \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            IPHONEOS_DEPLOYMENT_TARGET=15.0 \
            OTHER_LDFLAGS="-Wl,-no_fixup_chains" \
            ARCHS=arm64

      - name: Package IPA
        run: |
          mkdir Payload
          
          # Find app in build directory (since we are using 'build' action again)
          APP_DIR=$(find build -type d -name "WebDriverAgentRunner-Runner.app" | head -n 1)
          
          if [ -z "$APP_DIR" ]; then
            echo "Error: Could not find .app in build directory"
            find build
            exit 1
          fi
          
          echo "Found compiled app at: $APP_DIR"
          
          # Function to process binaries: check architecture and force arm64
          process_binary() {
              local bin="$1"
              if [ ! -f "$bin" ]; then return; fi
              
              echo "Processing binary: $bin"
              # Check if it is a binary (Mach-O)
              if file "$bin" | grep -q "Mach-O"; then
                  # Always force thin to arm64 to be safe (strips any x86_64 or other archs)
                  echo "  -> Thinning to arm64"
                  lipo -thin arm64 "$bin" -output "$bin.arm64" 2>/dev/null && mv "$bin.arm64" "$bin" || echo "  -> Lipo failed or already thin"
                  chmod +x "$bin"
              fi
          }
          
          # 4. Enforce Strict Bundle ID and Type Structure (Match EasyClick)
          # Host App: com.facebook.WebDriverAgentRunner.xctrunner (APPL)
          # PlugIn:   com.facebook.WebDriverAgentRunner (BNDL)
          # This ensures the PlugIn ID is a generic prefix, allowing AiSi to sign the Host App with a specific ID.
          
          echo "Enforcing Main App Bundle ID & Type..."
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.facebook.WebDriverAgentRunner.xctrunner" "$APP_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundlePackageType APPL" "$APP_DIR/Info.plist" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :CFBundlePackageType string APPL" "$APP_DIR/Info.plist"

          echo "Enforcing xctest Plugin Bundle ID & Type..."
          PLUGIN_INFO="$APP_DIR/PlugIns/WebDriverAgentRunner.xctest/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.facebook.WebDriverAgentRunner" "$PLUGIN_INFO"
          /usr/libexec/PlistBuddy -c "Set :CFBundlePackageType BNDL" "$PLUGIN_INFO" 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Add :CFBundlePackageType string BNDL" "$PLUGIN_INFO"

          # 5. Bundle Private XCTest Frameworks (Crucial for Standalone Running)
          # We need these enabled because the app crashes without them (missing dependencies).
          # Now that we removed the dummy profile, AiSi should sign these correctly.
          
          echo "Bundling XCTest frameworks..."
          FRAMEWORKS_DIR="$APP_DIR/Frameworks"
          mkdir -p "$FRAMEWORKS_DIR"
          
          # Source paths (macos-latest Xcode 15/16 structure)
          PLATFORM_DEV="/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer"
          LIB_FW="$PLATFORM_DEV/Library/Frameworks"
          PVT_FW="$PLATFORM_DEV/Library/PrivateFrameworks"
          
          cp -R "$LIB_FW/XCTest.framework" "$FRAMEWORKS_DIR/" || echo "Warning: XCTest.framework not found"
          cp -R "$LIB_FW/Testing.framework" "$FRAMEWORKS_DIR/" 2>/dev/null || true
          
          cp -R "$PVT_FW/XCTAutomationSupport.framework" "$FRAMEWORKS_DIR/" || echo "Warning: XCTAutomationSupport not found"
          cp -R "$PVT_FW/XCTestCore.framework" "$FRAMEWORKS_DIR/" || true
          cp -R "$PVT_FW/XCUIAutomation.framework" "$FRAMEWORKS_DIR/" || true
          
          # 6. Remove dSYM debug symbols (CRITICAL - causes installation failure)
          # dSYM bundles contain unsigned metadata that iOS rejects
          echo "Removing .dSYM debug symbol bundles..."
          find "$APP_DIR" -name "*.dSYM" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # 6. Ad-Hoc Sign binaries (Ensure valid binary structure)
          # We sign to give it valid Mach-O structure, but provide NO profile.
          # This forces AiSi Helper to insert a real profile during signing.
          
          echo "Ad-hoc signing binaries (No profile included)..."
          

          # 5. Simple Ad-Hoc Sign (Avoid fake entitlements)
          # AiSi Helper often flags IPAs with "get-task-allow" as "Jailbreak/Dev" if checks fail.
          # We just generic sign to ensure binary validity.
          
          echo "Ad-hoc signing binaries (No specific entitlements)..."
          
          # Sign Frameworks
          find "$APP_DIR/Frameworks" -type f -name "*.dylib" -o -name "*.framework" | while read fw; do
              codesign -s - -f --preserve-metadata=identifier,flags "$fw"
          done
          
          # Sign PlugIns
          find "$APP_DIR/PlugIns" -type d -name "*.xctest" | while read pl; do
              codesign -s - -f --preserve-metadata=identifier,flags "$pl"
          done
          
          # Sign Main App
          codesign -s - -f --preserve-metadata=identifier,flags "$APP_DIR"
          
          echo "Verifying Info.plist..."
          plutil -p "$APP_DIR/Info.plist"
          
          cp -r "$APP_DIR" Payload/
          zip -r WebDriverAgentRunner.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: WebDriverAgentRunner-IPA
          path: WebDriverAgentRunner.ipa
